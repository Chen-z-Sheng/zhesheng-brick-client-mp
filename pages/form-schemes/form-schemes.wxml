<view class="container">
  <view class="header">
    <text class="title">{{formType === 'market' ? '行情报单' : '普通方案报单'}}</text>
  </view>

  <!-- 普通方案报单表单 -->
  <block wx:if="{{formType === 'normal'}}">
    <view class="form-section">
      <view class="form-item">
        <text class="label">选择方案</text>
        <view class="combined-input-select">
          <input class="input-with-select" placeholder="输入方案名称" bindinput="onPlanSearchInput" value="{{planSearchText}}" />
          <view class="select-arrow" bindtap="togglePlanDropdown">
            <text class="dropdown-icon">▼</text>
          </view>
        </view>
        <view class="dropdown-list" wx:if="{{showPlanDropdown}}">
          <view class="dropdown-item {{planIndex === index ? 'active' : ''}}" wx:for="{{filteredPlanList}}" wx:key="id" bindtap="selectPlan" data-index="{{index}}">
            {{item.name}}
          </view>
          <view class="dropdown-empty" wx:if="{{filteredPlanList.length === 0}}">
            没有找到匹配的方案
          </view>
        </view>
      </view>

      <!-- 动态渲染表单模板 -->
      <block wx:if="{{formTemplate && dynamicFormRules.length > 0}}">
        <view class="dynamic-form" style="--label-width: {{dynamicFormOptions.form.labelWidth}}">
          <!-- 循环渲染每个表单字段 -->
          <view wx:for="{{dynamicFormRules}}" wx:key="_fc_id" class="form-item" wx:if="{{!item.hidden && item.display}}">
            <text class="label {{item.required ? 'required' : ''}}">
              {{item.title}}{{item.required ? '*' : ''}}
            </text>

            <!-- 输入框/密码框 -->
            <block wx:if="{{item.type === 'input' || item.type === 'password'}}">
              <input class="input" type="{{item.inputType}}" value="{{dynamicFormData[item.bindField]}}" bindinput="onDynamicInputChange" data-field="{{item.bindField}}" placeholder="请输入{{item.title}}" disabled="{{item.disabled}}" />
            </block>

            <!-- 多选框 -->
            <block wx:elif="{{item.type === 'checkbox'}}">
              <checkbox-group bindchange="onDynamicCheckboxChange" data-field="{{item.bindField}}" value="{{dynamicFormData[item.bindField]}}">
                <view wx:for="{{item.options}}" wx:key="value" class="checkbox-item">
                  <checkbox value="{{item.value}}" />
                  <text class="checkbox-label">{{item.label}}</text>
                </view>
              </checkbox-group>
            </block>

            <!-- 文本域 -->
            <block wx:elif="{{item.type === 'textarea'}}">
              <textarea class="textarea" value="{{dynamicFormData[item.bindField]}}" bindinput="onDynamicInputChange" data-field="{{item.bindField}}" placeholder="请输入{{item.title}}" rows="{{item.props.rows || 3}}" />
            </block>

            <!-- 下拉选择 -->
            <block wx:elif="{{item.type === 'select'}}">
              <picker mode="selector" range="{{item.pickerRangeLabels}}" value="{{item.pickerRangeIndex}}" bindchange="onDynamicSelectChange" data-field="{{item.bindField}}" data-options="{{item.options}}">
                <view class="picker-input">
                  {{dynamicFormData[item.bindField] ? item.selectedLabel : '请选择' + item.title}}
                </view>
              </picker>
            </block>

            <!-- 数字输入框 -->
            <block wx:elif="{{item.type === 'number'}}">
              <input class="input" type="number" value="{{dynamicFormData[item.bindField]}}" bindinput="onDynamicInputChange" data-field="{{item.bindField}}" placeholder="请输入{{item.title}}" />
            </block>

            <!-- 暂不支持的类型提示 -->
            <block wx:else>
              <view class="unsupported-field">暂不支持{{item.type}}类型字段</view>
            </block>

            <!-- 字段说明 -->
            <text class="field-desc" wx:if="{{item.info}}">{{item.info}}</text>
          </view>
        </view>
      </block>

      <!-- 无模板提示 -->
      <block wx:elif="{{currentPlan && !formTemplate}}">
        <view class="empty-tip">该方案暂无配置表单模板</view>
      </block>
    </view>
  </block>

  <!-- 行情报单表单 -->
  <block wx:elif="{{formType === 'market'}}">
    <view class="form-section">
      <view class="form-item">
        <text class="label">选择商品</text>
        <view class="product-selector">
          <view wx:for="{{productList}}" wx:key="id" class="product-item {{item.selected ? 'selected' : ''}}" bindtap="toggleProductSelection" data-id="{{item.id}}">
            <text class="product-name">{{item.name}}</text>
            <text class="product-price">¥{{item.price}}</text>
          </view>
        </view>
      </view>

      <!-- 已选商品列表 -->
      <view class="selected-products" wx:if="{{selectedProducts.length > 0}}">
        <text class="section-title">已选商品</text>
        <view wx:for="{{selectedProducts}}" wx:key="id" class="selected-product-item">
          <view class="product-info">
            <text class="product-name">{{item.name}}</text>
            <text class="product-price">¥{{item.price}}</text>
          </view>
          <view class="quantity-control">
            <text class="quantity-btn" bindtap="decreaseQuantity" data-id="{{item.id}}">-</text>
            <input class="quantity-input" type="number" value="{{item.quantity}}" bindinput="onQuantityChange" data-id="{{item.id}}" />
            <text class="quantity-btn" bindtap="increaseQuantity" data-id="{{item.id}}">+</text>
          </view>
        </view>
      </view>

      <view class="form-item">
        <text class="label">快递单号</text>
        <input class="input" value="{{formData.expressNumber}}" bindinput="onInputChange" data-field="expressNumber" placeholder="请输入快递单号" />
      </view>

      <view class="form-item">
        <text class="label">备注</text>
        <textarea class="textarea" value="{{formData.remark}}" bindinput="onInputChange" data-field="remark" placeholder="请输入备注信息" />
      </view>

      <view class="form-item">
        <text class="label">预计回款金额</text>
        <view class="expected-return">¥{{expectedReturn}}</view>
      </view>
    </view>
  </block>

  <!-- 提交按钮 -->
  <view class="form-footer">
    <button class="draft-btn" bindtap="saveDraft">保存草稿</button>
    <button class="submit-btn" bindtap="submitForm">提交报单</button>
  </view>
</view>