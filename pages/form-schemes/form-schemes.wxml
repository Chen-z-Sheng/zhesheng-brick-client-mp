<view class="page-container">
  <!-- 方案选择区域（仅formType为normal时显示） -->
  <view class="plan-select-area" wx:if="{{formType === 'normal'}}">
    <!-- 方案搜索输入框 -->
    <view class="search-input-wrap">
      <input class="search-input" placeholder="请搜索/选择方案" value="{{planSearchText}}" bindfocus="focusPlanInput" bindinput="onPlanSearchInput" />
      <button class="dropdown-btn" bindtap="togglePlanDropdown" size="mini">
        {{showPlanDropdown ? '收起' : '展开'}}
      </button>
    </view>

    <!-- 方案下拉列表（加载中/无数据/列表）【修复wx:else问题】 -->
    <view class="plan-dropdown" wx:if="{{showPlanDropdown}}">
      <block wx:if="{{isLoadingPlans}}">
        <view class="loading-tip">加载中...</view>
      </block>
      <block wx:elif="{{filteredPlanList.length === 0}}">
        <view class="empty-tip">暂无方案</view>
      </block>
      <block wx:else>
        <view class="plan-item" wx:for="{{filteredPlanList}}" wx:key="id" bindtap="selectPlan" data-index="{{index}}">
          {{item.name}}
        </view>
      </block>
    </view>
  </view>

  <!-- 商品选择区域（仅formType为market时显示） -->
  <view class="product-select-area" wx:if="{{formType === 'market'}}">
    <!-- 商品搜索输入框 -->
    <view class="search-input-wrap">
      <input class="search-input" placeholder="请搜索/选择商品" value="{{productSearchText}}" bindfocus="focusProductInput" bindinput="onProductSearchInput" />
      <button class="dropdown-btn" bindtap="toggleProductDropdown" size="mini">
        {{showProductDropdown ? '收起' : '展开'}}
      </button>
    </view>

    <!-- 商品下拉列表（加载中/无数据/列表）【修复wx:else问题】 -->
    <view class="product-dropdown" wx:if="{{showProductDropdown}}">
      <block wx:if="{{isLoadingProducts}}">
        <view class="loading-tip">加载中...</view>
      </block>
      <block wx:elif="{{filteredProductList.length === 0}}">
        <view class="empty-tip">暂无商品</view>
      </block>
      <block wx:else>
        <view class="product-item" wx:for="{{filteredProductList}}" wx:key="id" bindtap="toggleProductSelection" data-id="{{item.id}}">
          <checkbox checked="{{item.selected}}" disabled="true" />
          <text>{{item.name}}</text>
          <text class="product-price">¥{{item.price}}</text>
        </view>
      </block>
    </view>

    <!-- 已选商品列表 -->
    <view class="selected-products" wx:if="{{selectedProducts.length > 0}}">
      <view class="selected-title">已选商品</view>
      <view class="selected-item" wx:for="{{selectedProducts}}" wx:key="id">
        <view class="item-info">
          <text>{{item.name}}</text>
          <text class="item-price">¥{{item.price}}</text>
        </view>
        <view class="item-quantity">
          <button bindtap="decreaseQuantity" data-id="{{item.id}}" size="mini">-</button>
          <input value="{{item.quantity}}" bindinput="onQuantityChange" data-id="{{item.id}}" type="number" />
          <button bindtap="increaseQuantity" data-id="{{item.id}}" size="mini">+</button>
        </view>
        <button bindtap="removeProduct" data-id="{{item.id}}" size="mini" class="remove-btn">删除</button>
      </view>
      <view class="expected-return">
        预计回款：¥{{expectedReturn}}
      </view>
    </view>
  </view>

  <!-- 动态表单区域 -->
  <view class="dynamic-form-container" wx:if="{{dynamicFormRules.length > 0}}">
    <block wx:for="{{dynamicFormRules}}" wx:key="bindField">
      <!-- 文本/数字/密码输入框 -->
      <view class="form-item" wx:if="{{item.componentType === 'input'}}">
        <label class="form-label">
          {{item.title}}
          <text class="required" wx:if="{{item.required}}">*</text>
        </label>
        <input class="form-input" type="{{item.inputType}}" value="{{dynamicFormData[item.bindField]}}" placeholder="请输入{{item.title}}" disabled="{{item.disabled}}" bindinput="onDynamicInputChange" data-field="{{item.bindField}}" />
      </view>

      <!-- 下拉选择器 -->
      <view class="form-item" wx:elif="{{item.componentType === 'select'}}">
        <label class="form-label">
          {{item.title}}
          <text class="required" wx:if="{{item.required}}">*</text>
        </label>
        <picker mode="selector" range="{{item.pickerRangeLabels}}" value="{{item.pickerRangeIndex}}" bindchange="onDynamicSelectChange" data-field="{{item.bindField}}" data-options="{{item.options}}">
          <view class="picker-input">
            {{item.selectedLabel || '请选择' + item.title}}
          </view>
        </picker>
      </view>

      <!-- 图片上传 -->
      <view class="form-item" wx:elif="{{item.componentType === 'image'}}">
        <label class="form-label">
          {{item.title}}
          <text class="required" wx:if="{{item.required}}">*</text>
        </label>
        <view class="image-upload" bindtap="chooseDynamicImage" data-field="{{item.bindField}}">
          <image wx:if="{{dynamicFormData[item.bindField]}}" src="{{dynamicFormData[item.bindField]}}" class="uploaded-image"></image>
          <view wx:else class="upload-placeholder">点击上传{{item.title}}</view>
        </view>
      </view>

      <!-- 文本域 -->
      <view class="form-item" wx:elif="{{item.componentType === 'textarea'}}">
        <label class="form-label">
          {{item.title}}
          <text class="required" wx:if="{{item.required}}">*</text>
        </label>
        <textarea class="form-textarea" value="{{dynamicFormData[item.bindField]}}" placeholder="请输入{{item.title}}" disabled="{{item.disabled}}" bindinput="onDynamicInputChange" data-field="{{item.bindField}}" />
      </view>

      <!-- 复选框组 -->
      <view class="form-item" wx:elif="{{item.componentType === 'checkbox'}}">
        <label class="form-label">
          {{item.title}}
          <text class="required" wx:if="{{item.required}}">*</text>
        </label>
        <checkbox-group bindchange="onDynamicCheckboxChange" data-field="{{item.bindField}}">
          <label wx:for="{{item.options}}" wx:key="value" class="checkbox-item">
            <checkbox value="{{item.value}}" checked="{{dynamicFormData[item.bindField].includes(item.value)}}" />
            {{item.label}}
          </label>
        </checkbox-group>
      </view>
    </block>
  </view>

  <!-- 提交/草稿按钮 -->
  <view class="btn-container">
    <button class="draft-btn" bindtap="saveDraft">保存草稿</button>
    <button class="submit-btn" bindtap="submitForm" type="primary">提交</button>
  </view>
</view>